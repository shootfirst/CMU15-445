# No SQL数据库

## Sql与NoSql数据库

### 关系型数据

是创建在关系模型基础上的数据库，借助于集合代数等数学概念和方法来处理数据库中的数据

优点：

事务一致性

复杂查询

缺点：

海量数据

高并发

表结构修改

### NoSql数据库

极高并发读写：redis

海量数据访问：mongodb






## Redis

### 数据类型

![redis数据结构和数据类型](redis_datastructure.png)


#### String

##### 底层数据结构

SDS

##### 编码方式

+ int

+ embstr

+ raw

##### 应用

+ 缓存对象

+ 计数

+ 分布式锁：

  - SET $uuid EX NX

  - 检测是否是自己的锁，是则释放


#### List

##### 底层数据结构

quicklist

用ziplist作为链表节点的链表

ziplist

prelen encoding type content

##### 应用

+ 消息队列（破产版）


#### hash

##### 底层数据结构

+ listpack：encoding content len

+ 哈希表：渐进式哈希


##### 应用

+ 当购物车


#### set

##### 底层数据结构

+ 整数集合

+ 哈希表

##### 应用

+ 点赞

+ 共同关注


#### zset

##### 底层数据结构

+ listpack

+ 跳表

##### 应用

+ 排行榜


#### bitmap

#### hyperloglog

#### geo

#### stream





### 持久化

#### AOF

每一条命令，写入内存后，在将命令写入aof文件

##### 落盘时机

+ 每次

+ 每秒

+ 从不

##### AOF重写

+ 子进程cow，对AOF文件进行重写

+ 父进程执行客户端发来的命令，将执行后的写命令追加到AOF 缓冲区；将执行后的写命令追加到AOF 重写缓冲区；

+ 子进程结束，给父进程信号，父进程将AOF重写缓冲区数据写入AOF文件，然后替换之

#### RDB

记录某一时刻内存数据

##### RDB时机

##### RDB写


#### 混合持久化


### redis连接

#### redis多线程模型

redis主线程将套接字交给io线程去解析，然后将解析结果返回，由主线程执行，执行完毕后，对于写io，主线程仍然交给io线程


### 内存淘汰与过期淘汰

#### 过期淘汰

过期字典

##### 删除策略

+ 定时删除

+ 惰性删除

+ 定期删除

#### 内存淘汰

+ random

+ lru

+ lfu

+ ttl





### 缓存

##### 缓存雪崩

大量数据同时过期，或者redis宕机，导致大量访问mysql

+ 随机过期时间

+ 加互斥锁，保证同一时间只有一次访问redis

##### 缓存击穿

热点数据过期，导致访问mysql

##### 缓存穿透

redsi和mysql都尼玛没有

+ 使用布隆过滤器快速判断数据是否存在，避免通过查询数据库来判断数据是否存在

##### redis与mysql一致性

先更新数据库，再删除缓存











### 主从复制

#### 主从复制过程

+ 建立连接

+ 主服务器发送rdb

+ 主服务器发送 replication buffer 

+ 维护连接，命令传播


#### 主从断连后

增量复制：repl_backlog_buffer


#### 分摊主服务器压力


#### 主从不一致

+ 异步复制

+ 脑裂







## LSM Tree







